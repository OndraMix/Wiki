<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiki TSV Analyzátor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-container { max-height: 60vh; overflow-y: auto; }
        .loader-spin { border-top-color: #3b82f6; animation: spinner 0.8s linear infinite; }
        @keyframes spinner { to { transform: rotate(360deg); } }
        .progress-bar { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6 border border-slate-200">
            <h1 class="text-2xl font-bold text-slate-800 mb-2">Wiki TSV Analyzátor (Pokročilé funkce)</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-1">1. Neexistující články (TSV)</label>
                    <input type="file" id="fileInput" accept=".tsv,.txt" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
                    <p id="tsvStatus" class="mt-2 text-xs text-blue-600 italic">Nahrajte zdrojový TSV soubor</p>
                </div>

                <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-100">
                    <label class="block text-sm font-bold text-emerald-800 mb-1">2. Existující tituly (Seznam)</label>
                    <input type="file" id="existingFilesInput" accept=".tsv,.txt" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-600 file:text-white hover:file:bg-emerald-700 cursor-pointer">
                    <p id="existingStatus" class="mt-2 text-xs text-emerald-600 italic">Nahrajte seznam existujících článků</p>
                </div>
            </div>

            <!-- Ovládací prvky -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6 pt-6 border-t border-slate-100">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Hledat v názvu</label>
                    <input type="text" id="searchInput" placeholder="Zadejte hledaný výraz..." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Jm. prostor (ID)</label>
                    <input type="number" id="namespaceInput" placeholder="Všechny" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div class="flex flex-col gap-3 justify-center">
                    <label class="flex items-center cursor-pointer group">
                        <input type="checkbox" id="crossCheckToggle" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-slate-200 peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                        <span class="ms-3 text-xs font-semibold text-slate-700 group-hover:text-emerald-700 transition-colors">Křížová kontrola</span>
                    </label>
                </div>
            </div>
            
            <div id="loadingOverlay" class="hidden mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <div class="loader-spin rounded-full border-2 border-t-2 border-slate-200 h-4 w-4 mr-2"></div>
                        <span id="loaderText" class="text-xs font-bold text-blue-600 uppercase tracking-wider">Analyzuji data...</span>
                    </div>
                    <span id="progressPercent" class="text-xs font-mono text-slate-500">0%</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1.5 overflow-hidden">
                    <div id="progressBar" class="progress-bar bg-blue-600 h-1.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Statistiky -->
        <div id="statsBar" class="hidden flex flex-wrap gap-6 mb-4 px-4 py-2 bg-slate-800 text-white rounded-lg text-xs font-mono shadow-sm italic">
            <span>ZDROJ: <span id="totalCount" class="text-yellow-400">0</span></span>
            <span>EXISTUJÍCÍ: <span id="existingCount" class="text-emerald-400">0</span></span>
            <span>NALEZENO: <span id="filteredCount" class="text-blue-400">0</span></span>
            <span id="limitNotice" class="text-gray-400">| Limit 300 výsledků dosažen</span>
        </div>

        <!-- Tabulka -->
        <div id="resultsWrapper" class="hidden bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="table-container">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase border-b w-20">Prostor</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase border-b">Neexistující odkaz</th>
                            <th id="matchHeader" class="px-6 py-4 text-xs font-bold text-emerald-600 uppercase border-b hidden">Existující článek (Link)</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase border-b text-right">Užití</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100 text-sm"></tbody>
                </table>
            </div>
        </div>

        <div id="emptyState" class="text-center py-24 bg-white rounded-xl border-2 border-dashed border-slate-200">
            <p class="text-slate-400">Nahrajte soubory pro spuštění analýzy.</p>
        </div>
    </div>

    <!-- Web Worker Skript -->
    <script id="workerScript" type="text/javascript">
        self.onmessage = function(e) {
            const { type, missingData, existingTitlesMap, maxMatches = 300 } = e.data;

            if (type === 'crossCheck') {
                const results = [];
                const total = missingData.length;
                
                function getDiff(s1, s2) {
                    if (Math.abs(s1.length - s2.length) > 1) return null;
                    let edits = 0, i = 0, j = 0, diffChar = '';
                    while (i < s1.length && j < s2.length) {
                        if (s1[i] !== s2[j]) {
                            edits++;
                            if (edits > 1) return null;
                            if (s1.length > s2.length) { diffChar = s1[i]; i++; }
                            else if (s2.length > s1.length) { diffChar = s2[j]; j++; }
                            else { diffChar = s1[i]; i++; j++; }
                        } else { i++; j++; }
                    }
                    if (i < s1.length) { edits++; diffChar = s1[i]; }
                    if (j < s2.length) { edits++; diffChar = s2[j]; }
                    return (edits === 1 && !/[\d]/.test(diffChar)) ? true : null;
                }

                for (let i = 0; i < total; i++) {
                    const row = missingData[i];
                    const mTitle = row[1] || '';
                    const L = mTitle.length;
                    let foundForThisRow = null;

                    const lengthsToCheck = [L - 1, L, L + 1];
                    for (const len of lengthsToCheck) {
                        const candidates = existingTitlesMap.get(len);
                        if (!candidates) continue;
                        
                        for (let k = 0; k < candidates.length; k++) {
                            const eTitle = candidates[k];
                            if (Math.abs(eTitle.charCodeAt(0) - mTitle.charCodeAt(0)) > 5) continue;
                            if (getDiff(mTitle, eTitle)) {
                                foundForThisRow = eTitle;
                                break;
                            }
                        }
                        if (foundForThisRow) break;
                    }

                    if (foundForThisRow) {
                        results.push({...row, match: foundForThisRow});
                    }

                    if (i % 250 === 0 || i === total - 1) {
                        self.postMessage({ type: 'progress', percent: Math.round((i / total) * 100) });
                    }

                    if (results.length >= maxMatches) break;
                }
                self.postMessage({ type: 'result', results, reachedMax: results.length >= maxMatches });
            }
        };
    </script>

    <script>
        let rawData = [];
        let existingTitlesMap = new Map();
        let existingCount = 0;
        let worker;

        const blob = new Blob([document.getElementById('workerScript').textContent], { type: 'text/javascript' });
        worker = new Worker(window.URL.createObjectURL(blob));

        const fileInput = document.getElementById('fileInput');
        const existingFilesInput = document.getElementById('existingFilesInput');
        const searchInput = document.getElementById('searchInput');
        const namespaceInput = document.getElementById('namespaceInput');
        const crossCheckToggle = document.getElementById('crossCheckToggle');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const tableBody = document.getElementById('tableBody');
        const limitNotice = document.getElementById('limitNotice');

        fileInput.addEventListener('change', async e => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('tsvStatus').textContent = "Načítám...";
            const text = await file.text();
            processMissing(text);
            document.getElementById('tsvStatus').textContent = `Načteno ${rawData.length} řádků.`;
        });

        existingFilesInput.addEventListener('change', async e => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('existingStatus').textContent = "Indexuji...";
            const text = await file.text();
            processExisting(text);
            document.getElementById('existingStatus').textContent = `Hotovo (${existingCount} titulů).`;
        });

        [searchInput, namespaceInput, crossCheckToggle].forEach(el => {
            el.addEventListener('input', render);
        });

        function processMissing(text) {
            const lines = text.split(/\r?\n/);
            rawData = lines.map(l => l.split('\t')).filter(p => p.length >= 2);
            if (rawData.length > 0 && isNaN(parseInt(rawData[0][2]))) rawData.shift();
            document.getElementById('totalCount').textContent = rawData.length.toLocaleString();
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsWrapper').classList.remove('hidden');
            document.getElementById('statsBar').classList.remove('hidden');
            render();
        }

        function processExisting(text) {
            const lines = text.split(/\r?\n/);
            existingTitlesMap = new Map();
            existingCount = 0;
            lines.forEach(line => {
                const parts = line.split('\t');
                const title = parts.length > 1 ? parts[1] : parts[0];
                if (!title || title === 'page_title') return;
                const len = title.length;
                if (!existingTitlesMap.has(len)) existingTitlesMap.set(len, []);
                existingTitlesMap.get(len).push(title);
                existingCount++;
            });
            document.getElementById('existingCount').textContent = existingCount.toLocaleString();
            if (rawData.length > 0) render();
        }

        worker.onmessage = function(e) {
            if (e.data.type === 'progress') {
                progressBar.style.width = e.data.percent + '%';
                progressPercent.textContent = e.data.percent + '%';
            } else if (e.data.type === 'result') {
                displayResults(e.data.results);
                limitNotice.classList.toggle('hidden', !e.data.reachedMax);
                loadingOverlay.classList.add('hidden');
            }
        };

        function render() {
            const query = searchInput.value.trim().toLowerCase();
            const nsFilter = namespaceInput.value.trim();
            const useCross = crossCheckToggle.checked;

            if (useCross && existingCount === 0) {
                alert("Nejdříve nahrajte seznam existujících článků.");
                crossCheckToggle.checked = false;
                return;
            }

            let filtered = rawData;
            
            // Filtr jmenného prostoru
            if (nsFilter !== "") {
                filtered = filtered.filter(row => row[0] === nsFilter);
            }
            
            // Vyhledávací filtr
            if (query) {
                filtered = filtered.filter(row => (row[1] || '').toLowerCase().includes(query));
            }

            if (useCross) {
                loadingOverlay.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressPercent.textContent = '0%';
                
                worker.postMessage({
                    type: 'crossCheck',
                    missingData: filtered,
                    existingTitlesMap: existingTitlesMap,
                    maxMatches: 300
                });
            } else {
                limitNotice.classList.add('hidden');
                displayResults(filtered);
            }
        }

        function displayResults(data) {
            document.getElementById('matchHeader').classList.toggle('hidden', !crossCheckToggle.checked);
            document.getElementById('filteredCount').textContent = data.length.toLocaleString();
            
            const renderLimit = 500; 
            const showData = data.slice(0, renderLimit);

            tableBody.innerHTML = showData.map(row => {
                const title = row[1] || '';
                const whatLinksUrl = `https://cs.wikipedia.org/wiki/Speci%C3%A1ln%C3%AD:Co_odkazuje_na?target=${encodeURIComponent(title)}`;
                
                let matchCell = '';
                if (crossCheckToggle.checked) {
                    const matchTitle = row.match || '';
                    const articleUrl = `https://cs.wikipedia.org/wiki/${encodeURIComponent(matchTitle)}`;
                    matchCell = row.match 
                        ? `<td class="px-6 py-4 bg-emerald-50/30">
                            <a href="${articleUrl}" target="_blank" class="text-emerald-700 font-bold hover:underline flex items-center gap-1">
                                ${matchTitle}
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                            </a>
                           </td>` 
                        : '<td></td>';
                }
                
                return `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 text-slate-400 font-mono text-[10px]">${row[0]}</td>
                    <td class="px-6 py-4">
                        <a href="${whatLinksUrl}" target="_blank" class="text-blue-600 hover:underline font-medium">${title}</a>
                    </td>
                    ${matchCell}
                    <td class="px-6 py-4 text-right font-mono text-slate-500">${row[2] || '1'}</td>
                </tr>`;
            }).join('');

            if (data.length === 0 && crossCheckToggle.checked) {
                tableBody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-400 italic">V prohledávaném úseku nebyla nalezena žádná podobná existující varianta.</td></tr>`;
            }
        }
    </script>
</body>
</html>